/\*\*

- @ Author: firstfu
- @ Create Time: 2024-05-19 21:25:39
- @ Description: 認證系統實現方案
  \*/

# 血壓記錄 App - 認證系統實現方案

## 1. 專案概述

本文檔詳細說明基於 Next.js API 路由和 Supabase 實現的血壓記錄 App 後端系統，包括用戶認證和數據存儲方案。系統將同時支持網頁應用和 Flutter 移動應用。

## 2. 技術選型

### 2.1 核心技術

- **前端**: Next.js (網頁版), Flutter (移動應用)
- **後端**: Next.js API 路由
- **數據庫**: PostgreSQL (Supabase 託管)
- **身份認證**: Supabase Auth
- **ORM**: Supabase JS 客戶端
- **部署**: Vercel (網頁版), App Store/Google Play (移動應用)

### 2.2 技術選型依據

1. **Supabase** 作為 Firebase 的開源替代品，提供功能豐富的身份認證和數據存儲服務
2. **Next.js API 路由** 允許我們在同一環境中構建前後端，簡化部署和維護
3. **PostgreSQL** 提供強大的關係型數據庫功能，適合存儲結構化的健康數據
4. **Flutter** 支持跨平台開發，減少開發和維護成本

## 3. 系統架構

```
                  +---------------------+
                  |                     |
                  |  Flutter 移動應用    |
                  |                     |
                  +---------+-----------+
                            |
                            | API 請求
                            v
+------------+      +-------+---------+
|            |      |                 |
|  網頁應用   +----->+  Next.js API    |
|            |      |                 |
+------------+      +-------+---------+
                            |
                            | 數據操作/認證
                            v
                    +-------+---------+
                    |                 |
                    |    Supabase     |
                    |                 |
                    +-------+---------+
                            |
                            | 底層存儲
                            v
                    +-------+---------+
                    |                 |
                    |   PostgreSQL    |
                    |                 |
                    +-----------------+
```

## 4. 數據模型設計

### 4.1 用戶認證模型

Supabase Auth 提供內置的用戶認證表 `auth.users`，我們在此基礎上拓展用戶資料，包含個人資料表 (profiles)。

### 4.2 血壓記錄模型

血壓記錄表 (blood_pressure_records) 用於存儲用戶的血壓測量數據。

### 4.3 提醒模型

提醒表 (reminders) 用於管理用戶設置的測量提醒。

### 4.4 醫生數據模型 (未來擴展功能)

包含醫生表 (doctors) 和用戶-醫生關聯表 (user_doctors)，用於未來的醫患互動功能。

## 5. 認證策略

### 5.1 認證方式

系統將支援多種認證方式：

1. **社交登入**: Apple, Google
2. **電子郵件密碼**: 傳統登入方式
3. **遊客模式**: 無需登入，但功能受限

### 5.2 權限控制

使用 Supabase 的行級安全性 (RLS) 實現細粒度的權限控制：

- 每個用戶只能訪問自己的資料
- 遊客可以查看應用的演示功能
- 數據敏感操作需要身份驗證

### 5.3 Token 管理

- 使用 JWT 為已認證用戶提供訪問權限
- 令牌有效期設定為 1 小時
- 提供刷新令牌機制，避免頻繁登入
- 安全存儲令牌，避免 XSS 攻擊

## 6. 數據安全策略

### 6.1 數據加密

- 傳輸中的數據使用 HTTPS 加密
- 敏感健康數據使用 Supabase 的行級加密功能

### 6.2 數據訪問控制

- 實施嚴格的行級安全策略
- API 端點權限驗證
- 敏感操作日誌記錄

### 6.3 合規性

- 遵循健康數據隱私標準
- 實施數據保留策略
- 提供數據導出功能

## 7. 遊客訪問與登入彈窗

### 7.1 遊客訪問策略

遊客用戶可訪問以下功能：

- 瀏覽應用主界面
- 查看功能介紹
- 查看血壓知識庫等靜態內容
- 查看應用功能演示
- 查看血壓測量指南

### 7.2 登入彈窗觸發時機

以下操作將觸發登入/註冊彈窗：

- 嘗試添加新血壓記錄
- 嘗試查看歷史記錄
- 嘗試設置個人資料
- 嘗試設置提醒
- 嘗試導出/分享數據
- 嘗試修改或刪除任何數據

## 8. 實現進度規劃

| 階段 | 工作項目                    | 時間估計 | 完成標誌                              |
| ---- | --------------------------- | -------- | ------------------------------------- |
| 1    | Supabase 項目創建與初始配置 | 1 天     | Supabase 項目已創建、數據庫模式已定義 |
| 1    | 數據庫遷移腳本開發          | 1 天     | 遷移腳本已測試且運行正常              |
| 2    | Apple 登入 API 開發         | 2 天     | API 能正常處理 Apple 登入請求         |
| 2    | Google 登入 API 開發        | 1 天     | API 能正常處理 Google 登入請求        |
| 3    | 電子郵件登入 API 開發       | 1 天     | API 能處理電子郵件登入                |
| 3    | Flutter 客戶端認證組件開發  | 3 天     | 移動應用能正常使用登入功能            |
| 4    | 血壓記錄 API 開發           | 2 天     | 所有血壓記錄 CRUD 操作可用            |
| 4    | 提醒 API 開發               | 2 天     | 所有提醒 CRUD 操作可用                |
| 5    | 系統測試與除錯              | 2 天     | 所有 API 通過測試                     |
| 5    | 部署與配置                  | 1 天     | 系統成功部署並運行                    |

## 9. 總結

本方案提供了適用於血壓記錄 App 的完整認證系統設計。系統基於 Next.js API 路由和 Supabase 構建，提供強大的數據管理和身份認證功能。採用這種架構可以快速開發、安全部署，並在未來根據需求輕鬆擴展功能。
